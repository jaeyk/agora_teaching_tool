---
title: "create_maps"
author: "Jae Yeon Kim"
output: html_document
---

# Setup 

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
```

```{r}
# Load pkgs 

if (!require(pacman)) install.packages("pacman")
pacman::p_load(leaflet, glue, sf, tigris, tidyverse, here, shiny, htmltools, htmlwidgets, DT)

```

```{r, echo = FALSE}
# Load data 

# Load county-level outcomes
df <- read.csv(here("raw_data", "cnty_counts_cov.csv"))

sum(df$FIPS == 9009) # including New Haven County
```

```{r}
counties <- readr::read_rds(here("raw_data", "counties.rds"))

states <- readr::read_rds(here("raw_data", "states.rds"))

#list.files(here("raw_data"))

# Load county boundaries (US states from tigris package)

# counties <- counties(cb = TRUE)
# readr::write_rds(counties, here("raw_data", "counties.rds"))

# Load state boundaries (US states from tigris package)
# states <- states(cb = TRUE)
# write_rds(states, here("raw_data", "states.rds"))
```

# Data prep

```{r}
# Ensure FIPS codes match
df$fips <- sprintf("%05d", df$FIPS)

sum(df$fips == "09009") # including New Haven County

setdiff(df$fips,counties$GEOID) # for some reason tigris::counties() does not include the following 8 counties in CT 
```

```{r}
# Merge datasets
map_data <- left_join(counties, df, by = c("GEOID" = "fips"))

sum(map_data$FIPS == 9009) # doesn't include New Haven
```

```{r}
# Merge state boundaries with map_data if necessary
map_data <- st_as_sf(map_data)  # Ensure it's an sf object
map_data <- st_transform(map_data, crs = st_crs(states))  # Match CRS
```

```{r}
# Create categorical bins (1 to 5)
map_data <- map_data %>%
  mutate(civic_opp_category = ntile(civic_opp_sum_normalized, 5))  # Divides into 5 groups (1-5)
```

# Create an interactive map

```{r}
options(shiny.launch.browser = TRUE)
```

```{r}
# Update the county_info field with NAMELSAD in bold
map_data <- map_data %>%
  mutate(county_info = glue("<b>{NAMELSAD}</b><br/>Civic opportunity index: {civic_opp_index}"))

ui <- fillPage(
  tags$head(
    tags$style(HTML("
      .leaflet-popup-content { 
        white-space: pre-wrap; 
      }
    "))
  ),
  leafletOutput("civic_map", width = "100%", height = "100vh"),
  verbatimTextOutput("info")
)

server <- function(input, output, session) {
  
  # Define a custom green color palette for 5 categories
  green_colors <- c("#edf8e9", "#bae4b3", "#74c476", "#31a354", "#006d2c")
  pal_green <- colorFactor(palette = green_colors, domain = map_data$civic_opp_category)
  
  output$civic_map <- renderLeaflet({
    leaflet(map_data) %>%
      addTiles() %>%
      addPolygons(
        fillColor = ~pal_green(civic_opp_category),
        fillOpacity = 0.7,
        color = "#BDBDC1",
        weight = 1,
        popup = ~county_info,  # Use I() to treat the label as safe HTML
        labelOptions = labelOptions(
          style = list("font-weight" = "normal", padding = "3px 8px"),
          textsize = "15px",
          direction = "auto"
        ),
        group = "Counties"
      ) %>%
      addPolygons(
        data = states,
        color = "black",
        weight = 2,
        fillOpacity = 0,
        group = "States",
        options = pathOptions(clickable = FALSE)
      ) %>%
      addLegend(
        pal = pal_green,
        values = map_data$civic_opp_category,
        title = "Civic Opportunity Index",
        labFormat = function(type, cuts, p) paste0(cuts)
      ) %>%
      setView(lng = -95.7129, lat = 37.0902, zoom = 4)
  })
  
  output$info <- renderText("")
}

shinyApp(ui, server)
```

# Create an additional visualization tool

```{r}
df <- df %>%
  mutate(FIPS = str_pad(as.character(FIPS), width = 5, side = "left", pad = "0"))

# Load FIPS-to-county lookup
fips_lookup <- read_csv(
  "https://www2.census.gov/geo/docs/reference/codes/files/national_county.txt",
  col_names = c("state_abbr", "state_fips", "county_fips", "county_name", "fips_class"),
  col_types = "ccccc"
) %>%
  mutate(FIPS = str_c(state_fips, county_fips)) %>%
  select(FIPS, county_name, state_abbr)
```

```{r}
# Now safe to join
df_joined <- df %>%
  left_join(fips_lookup, by = "FIPS") %>%
  filter(!is.na(county_name)) %>%
  mutate(
    civic_opp_percentile = percent_rank(civic_opp_sum_normalized),
    civic_opp_percentile_label = case_when(
      civic_opp_percentile >= 0.99 ~ "Top 1%",
      civic_opp_percentile >= 0.95 ~ "Top 5%",
      civic_opp_percentile >= 0.90 ~ "Top 10%",
      civic_opp_percentile >= 0.75 ~ "Top 25%",
      civic_opp_percentile >= 0.50 ~ "Top 50%",
      civic_opp_percentile >= 0.25 ~ "Bottom 50%",
      civic_opp_percentile >= 0.10 ~ "Bottom 25%",
      civic_opp_percentile >= 0.05 ~ "Bottom 10%",
      TRUE ~ "Bottom 5%"
    )
  )
```

```{r}
# UI
ui <- fluidPage(
  titlePanel("Find Similar Counties by Civic Opportunity Score"),
  sidebarLayout(
    sidebarPanel(
      selectInput("selected_state", "Select a State:",
                  choices = sort(unique(df_joined$state_abbr))),
      
      selectInput("selected_county", "Select a County:",
                  choices = NULL)  # we'll update this dynamically
    ),
    mainPanel(
      h4("10 Most Similar Counties + Selected (with Percentile)"),
      DTOutput("similar_table")
    )
  )
)

# Server
server <- function(input, output, session) {
  # Update county list when state changes
  observeEvent(input$selected_state, {
    counties_in_state <- df_joined %>%
      filter(state_abbr == input$selected_state) %>%
      arrange(county_name) %>%
      pull(county_name) %>%
      unique()
    
    updateSelectInput(session, "selected_county",
                      choices = counties_in_state,
                      selected = counties_in_state[1])
  })
  
  output$similar_table <- renderDT({
    req(input$selected_county)

    selected_row <- df_joined %>%
      filter(county_name == input$selected_county, state_abbr == input$selected_state)
    
    target_score <- selected_row$civic_opp_sum_normalized

    similar_rows <- df_joined %>%
      filter(!(county_name == input$selected_county & state_abbr == input$selected_state)) %>%
      mutate(score_diff = abs(civic_opp_sum_normalized - target_score)) %>%
      arrange(score_diff) %>%
      head(10)

    combined <- bind_rows(selected_row, similar_rows) %>%
      select(county_name, state_abbr, civic_opp_sum_normalized, civic_opp_percentile_label) %>%
      arrange(civic_opp_sum_normalized)

    datatable(combined, rownames = FALSE, options = list(dom = 't')) %>%
      formatStyle(
        'county_name',
        target = 'row',
        backgroundColor = styleEqual(input$selected_county, 'lightgreen')
      )
  })
}

# Run the app
shinyApp(ui, server)
```