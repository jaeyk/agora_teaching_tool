---
title: "Civic Opportunity Table"
format:
  html:
    page-layout: full
execute:
  echo: false
  warning: false
  message: false
---


```{r}
# Load pkgs
if (!require(pacman)) install.packages("pacman")
pacman::p_load(DT, tidyverse, here, htmltools)

# Load civic opportunity data
df <- read.csv(here("raw_data", "cnty_counts_cov.csv"))
df$fips <- sprintf("%05d", df$FIPS)

# Load org type data
org_types <- read.csv(here("raw_data", "cnty_civic_org_type.csv")) %>%
  mutate(fips = sprintf("%05d", FIPS)) %>%
  filter(!is.na(class)) %>%
  group_by(fips, class) %>%
  summarise(count = sum(freq, na.rm = TRUE), .groups = "drop") %>%
  group_by(fips) %>%
  mutate(total = sum(count), pct = round(100 * count / total, 2)) %>%
  ungroup() %>%
  select(fips, class, pct) %>%
  pivot_wider(names_from = class, values_from = pct, values_fill = 0)

# Load FIPS-to-county lookup
fips_lookup <- read_csv(
  "https://www2.census.gov/geo/docs/reference/codes/files/national_county.txt",
  col_names = c("state_abbr", "state_fips", "county_fips", "county_name", "fips_class"),
  col_types = "ccccc"
) %>%
  mutate(FIPS = str_c(state_fips, county_fips)) %>%
  select(FIPS, county_name, state_abbr)

# Join and compute columns
df_joined <- df %>%
  mutate(FIPS = sprintf("%05d", FIPS)) %>%
  left_join(fips_lookup, by = "FIPS") %>%
  left_join(org_types, by = c("FIPS" = "fips")) %>%
  filter(!is.na(county_name)) %>%
  mutate(
    civic_opp_index = ntile(civic_opp_sum_normalized, 5),
    civic_opp_percentile = percent_rank(civic_opp_sum_normalized),
    civic_opp_percentile_label = case_when(
      civic_opp_percentile >= 0.99 ~ "Top 1%",
      civic_opp_percentile >= 0.95 ~ "Top 5%",
      civic_opp_percentile >= 0.90 ~ "Top 10%",
      civic_opp_percentile >= 0.75 ~ "Top 25%",
      civic_opp_percentile >= 0.50 ~ "Top 50%",
      civic_opp_percentile >= 0.25 ~ "Bottom 50%",
      civic_opp_percentile >= 0.10 ~ "Bottom 25%",
      civic_opp_percentile >= 0.05 ~ "Bottom 10%",
      TRUE ~ "Bottom 5%"
    )
  ) %>%
  group_by(state_abbr) %>%
  mutate(state_rank = rank(desc(civic_opp_sum_normalized), ties.method = "min")) %>%
  ungroup() %>%
  mutate(national_rank = rank(desc(civic_opp_sum_normalized), ties.method = "min")) %>%
  select(
    State = state_abbr,
    County = county_name,
    `Civic Opportunity Index` = civic_opp_index,
    Percentile = civic_opp_percentile_label,
    `State Rank` = state_rank,
    `National Rank` = national_rank,
    `Civic Opportunity Orgs` = civic_org_sum,
    `Total Nonprofits` = n,
    `Volunteer %` = volunteer_sum,
    `Membership %` = membership_sum,
    `Take Action %` = take_action_sum,
    `Events %` = events_sum,
    `Religious %` = Religious,
    `Social & Fraternal %` = `Social & Fraternal`,
    `Youth %` = Youth,
    `Unions %` = Unions,
    `Healthcare %` = Healthcare,
    `Economic %` = Economic,
    `Education %` = Education,
    `Research & Think Tank %` = `Research & Think Tank`,
    `Hobby & Sports %` = `Hobby & Sports`,
    `Community %` = Community,
    `Foundations %` = Foundations,
    `Professional %` = Professional,
    `Arts & Cultural %` = `Arts & Cultural`,
    `Housing %` = Housing,
    `Political %` = Political
  ) %>%
  arrange(desc(`Civic Opportunity Index`))

# Render the table
datatable(
  df_joined,
  rownames = FALSE,
  extensions = c('FixedColumns'),
  options = list(
    dom = 'frtip',
    scrollX = TRUE,
    scrollCollapse = TRUE,
    fixedColumns = list(leftColumns = 2),
    pageLength = 25
  ),
  filter = "top",
  class = 'stripe hover nowrap'
)
```