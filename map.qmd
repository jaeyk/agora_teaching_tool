---
title: "Civic Opportunity Map"
format: html
execute:
  echo: false
  warning: false
  message: false
---

```{r}
# Load packages
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
pacman::p_load(leaflet, glue, sf, tigris, tidyverse, here, htmlwidgets, viridis, DT)

# Load and prepare data
df <- read.csv(here::here("raw_data", "cnty_counts_cov.csv"))
df$fips <- sprintf("%05d", df$FIPS)

counties <- readr::read_rds(here::here("raw_data", "counties.rds"))
states <- readr::read_rds(here::here("raw_data", "states.rds"))

map_data <- left_join(counties, df, by = c("GEOID" = "fips")) %>%
  st_as_sf() %>%
  st_transform(crs = st_crs(states)) %>%
  mutate(
    civic_opp_category = ntile(civic_opp_sum_normalized, 5),
    county_info = glue("<b>{NAMELSAD}</b><br/>Civic opportunity index: {round(civic_opp_index, 2)}<br/>Civic orgs per 1k: {round(civic_opp_sum_normalized, 2)}")
  ) %>%
  mutate(
    civic_opp_rounded_up = round(civic_opp_sum_normalized, 0),
    civic_opp_percentile = percent_rank(civic_opp_sum_normalized),
    civic_opp_percentile_label = case_when(
      civic_opp_percentile >= 0.99 ~ "Top 1%",
      civic_opp_percentile >= 0.95 ~ "Top 5%",
      civic_opp_percentile >= 0.90 ~ "Top 10%",
      civic_opp_percentile >= 0.75 ~ "Top 25%",
      civic_opp_percentile >= 0.50 ~ "Top 50%",
      civic_opp_percentile >= 0.25 ~ "Bottom 50%",
      civic_opp_percentile >= 0.10 ~ "Bottom 25%",
      civic_opp_percentile >= 0.05 ~ "Bottom 10%",
      TRUE ~ "Bottom 5%")
    )

# Define color palette
pal_green <- colorFactor(viridis(5), domain = map_data$civic_opp_category)

# Render map
leaflet(map_data, options = leafletOptions(minZoom = 3, zoomControl = TRUE)) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(
    fillColor = ~pal_green(civic_opp_category),
    fillOpacity = 0.7,
    color = "#BDBDC1",
    weight = 1,
    popup = ~glue("<b>{NAMELSAD}</b><br/>
                   Civic Opportunity Index: {round(civic_opp_index, 2)}<br/>
                   Civic Opportunity per 1k: {round(civic_opp_sum_normalized, 2)}<br/>
                   Civic Opportunity Percentile: {civic_opp_percentile_label}"),
    label = ~paste0("County: ", NAMELSAD),
    group = "Counties"
  ) %>%
  addPolygons(
    data = states,
    color = "black",
    weight = 2,
    fillOpacity = 0,
    group = "States",
    options = pathOptions(clickable = FALSE)
  ) %>%
  addLegend(
    pal = pal_green,
    values = map_data$civic_opp_category,
    title = "Civic Opportunity Index",
    position = "bottomright"
  ) %>%
  addScaleBar(position = "bottomleft") %>%
  addEasyButton(
    easyButton(
      icon = "fa-globe", title = "Reset Zoom",
      onClick = JS("function(btn, map){ map.setView([37.0902, -95.7129], 4); }")
    )
  ) %>%
  addLayersControl(
    overlayGroups = c("Counties", "States"),
    position = "topright"
  ) %>%
  setView(lng = -95.7129, lat = 37.0902, zoom = 4) %>%
  removeControl("zoom") %>%
  removeControl("geolocate")
```