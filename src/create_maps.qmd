---
title: "create_maps"
author: "Jae Yeon Kim"
output: html_document
---

# Setup 

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
```

```{r}
# Load pkgs 

if (!require(pacman)) install.packages("pacman")
pacman::p_load(leaflet, glue, sf, tigris, readr, dplyr, here, shiny, htmltools, htmlwidgets)

```

```{r, echo = FALSE}
# Load data 

# Load county-level outcomes
df <- read.csv(here("raw_data", "cnty_counts_cov.csv"))

sum(df$FIPS == 9009) # including New Haven County
```

```{r}
counties <- readr::read_rds(here("raw_data", "counties.rds"))

states <- readr::read_rds(here("raw_data", "states.rds"))

#list.files(here("raw_data"))

# Load county boundaries (US states from tigris package)

# counties <- counties(cb = TRUE)
# readr::write_rds(counties, here("raw_data", "counties.rds"))

# Load state boundaries (US states from tigris package)
# states <- states(cb = TRUE)
# write_rds(states, here("raw_data", "states.rds"))
```

# Data prep

```{r}
# Ensure FIPS codes match
df$fips <- sprintf("%05d", df$FIPS)

sum(df$fips == "09009") # including New Haven County

setdiff(df$fips,counties$GEOID) # for some reason tigris::counties() does not include the following 8 counties in CT 
```

```{r}
# Merge datasets
map_data <- left_join(counties, df, by = c("GEOID" = "fips"))

sum(map_data$FIPS == 9009) # doesn't include New Haven
```

```{r}
# Merge state boundaries with map_data if necessary
map_data <- st_as_sf(map_data)  # Ensure it's an sf object
map_data <- st_transform(map_data, crs = st_crs(states))  # Match CRS
```

```{r}
# Create categorical bins (1 to 5)
map_data <- map_data %>%
  mutate(civic_opp_category = ntile(civic_opp_sum_normalized, 5))  # Divides into 5 groups (1-5)
```

# Create an interactive map

```{r}
options(shiny.launch.browser = TRUE)
```

```{r}
# Update the county_info field with NAMELSAD in bold
map_data <- map_data %>%
  mutate(county_info = glue("<b>{NAMELSAD}</b><br/>Civic opportunity index: {civic_opp_index}"))

ui <- fillPage(
  tags$head(
    tags$style(HTML("
      .leaflet-popup-content { 
        white-space: pre-wrap; 
      }
    "))
  ),
  leafletOutput("civic_map", width = "100%", height = "100vh"),
  verbatimTextOutput("info")
)

server <- function(input, output, session) {
  
  # Define a custom green color palette for 5 categories
  green_colors <- c("#edf8e9", "#bae4b3", "#74c476", "#31a354", "#006d2c")
  pal_green <- colorFactor(palette = green_colors, domain = map_data$civic_opp_category)
  
  output$civic_map <- renderLeaflet({
    leaflet(map_data) %>%
      addTiles() %>%
      addPolygons(
        fillColor = ~pal_green(civic_opp_category),
        fillOpacity = 0.7,
        color = "#BDBDC1",
        weight = 1,
        popup = ~county_info,  # Use I() to treat the label as safe HTML
        labelOptions = labelOptions(
          style = list("font-weight" = "normal", padding = "3px 8px"),
          textsize = "15px",
          direction = "auto"
        ),
        group = "Counties"
      ) %>%
      addPolygons(
        data = states,
        color = "black",
        weight = 2,
        fillOpacity = 0,
        group = "States",
        options = pathOptions(clickable = FALSE)
      ) %>%
      addLegend(
        pal = pal_green,
        values = map_data$civic_opp_category,
        title = "Civic Opportunity Index",
        labFormat = function(type, cuts, p) paste0(cuts)
      ) %>%
      setView(lng = -95.7129, lat = 37.0902, zoom = 4)
  })
  
  output$info <- renderText("")
}

shinyApp(ui, server)
```