---
title: "Civic Opportunity Table"
format:
  html:
    page-layout: full
    self-contained: true  # <-- for reliable local viewing
    theme: default
execute:
  echo: false
  warning: false
  message: false
---

::: {.callout-tip}
## Table Features
- **Sort** any column by clicking the header
- **Filter** using the search boxes below each column
- **Bookmark** counties by clicking the star icon - bookmarks are saved in your browser
- **Export** visible data using the Buttons menu
:::

```{r}
# Load pkgs
if (!require(pacman)) install.packages("pacman")
pacman::p_load(DT, tidyverse, here, htmltools)

# Load civic opportunity data
df <- read.csv(here("raw_data", "cnty_counts_cov.csv"))
df$fips <- sprintf("%05d", df$FIPS)

# Load org type data
org_types <- read.csv(here("raw_data", "cnty_civic_org_type.csv")) %>%
  mutate(fips = sprintf("%05d", FIPS)) %>%
  filter(!is.na(class)) %>%
  group_by(fips, class) %>%
  summarise(count = sum(freq, na.rm = TRUE), .groups = "drop") %>%
  group_by(fips) %>%
  mutate(total = sum(count), pct = round(100 * count / total, 2)) %>%
  ungroup() %>%
  select(fips, class, pct) %>%
  pivot_wider(names_from = class, values_from = pct, values_fill = 0)

# Load FIPS-to-county lookup
fips_lookup <- read_csv(
  "https://www2.census.gov/geo/docs/reference/codes/files/national_county.txt",
  col_names = c("state_abbr", "state_fips", "county_fips", "county_name", "fips_class"),
  col_types = "ccccc"
) %>%
  mutate(FIPS = str_c(state_fips, county_fips)) %>%
  select(FIPS, county_name, state_abbr)

# Join and compute columns
df_joined <- df %>%
  mutate(FIPS = sprintf("%05d", FIPS)) %>%
  left_join(fips_lookup, by = "FIPS") %>%
  left_join(org_types, by = c("FIPS" = "fips")) %>%
  filter(!is.na(county_name)) %>%
  mutate(
    civic_opp_index = ntile(civic_opp_sum_normalized, 5),
    civic_opp_percentile = percent_rank(civic_opp_sum_normalized),
    civic_opp_percentile_label = case_when(
      civic_opp_percentile >= 0.99 ~ "Top 1%",
      civic_opp_percentile >= 0.95 ~ "Top 5%",
      civic_opp_percentile >= 0.90 ~ "Top 10%",
      civic_opp_percentile >= 0.75 ~ "Top 25%",
      civic_opp_percentile >= 0.50 ~ "Top 50%",
      civic_opp_percentile >= 0.25 ~ "Bottom 50%",
      civic_opp_percentile >= 0.10 ~ "Bottom 25%",
      civic_opp_percentile >= 0.05 ~ "Bottom 10%",
      TRUE ~ "Bottom 5%"
    )
  ) %>%
  group_by(state_abbr) %>%
  mutate(state_rank = rank(desc(civic_opp_sum_normalized), ties.method = "min")) %>%
  ungroup() %>%
  mutate(civic_opp_sum_normalized = round(civic_opp_sum_normalized, 0)) %>%
  mutate(national_rank = rank(desc(civic_opp_sum_normalized), ties.method = "min")) %>%
  select(
    FIPS,
    State = state_abbr,
    County = county_name,
    `Civic Opp Score` = civic_opp_sum_normalized,
    `Index (1-5)` = civic_opp_index,
    Percentile = civic_opp_percentile_label,
    `State Rank` = state_rank,
    `Natl Rank` = national_rank,
    `Civic Orgs` = civic_org_sum,
    `Total Nonprofits` = n,
    `Membership N` = membership_sum,
    `Volunteer N` = volunteer_sum,
    `Events N` = events_sum,
    `Action N` = take_action_sum,
    `Religious %` = Religious,
    `Social %` = `Social & Fraternal`,
    `Youth %` = Youth,
    `Unions %` = Unions,
    `Health %` = Healthcare,
    `Econ %` = Economic,
    `Edu %` = Education,
    `Research %` = `Research & Think Tank`,
    `Sports %` = `Hobby & Sports`,
    `Community %` = Community,
    `Found %` = Foundations,
    `Prof %` = Professional,
    `Arts %` = `Arts & Cultural`,
    `Housing %` = Housing,
    `Political %` = Political
  ) %>%
  arrange(desc(`Index (1-5)`))
```

::: {.callout-note collapse=true title="üìò Civic Opportunity Counts and Organization Types"}

- **Civic opportunity per capita**: A normalized composite score representing the density of civic opportunity in a county. For each organization, we calculate the average of four binary indicators: **Membership**, **Volunteer**, **Public Events**, and **Take Civic or Political Action** (each scored 0 or 1). These are averaged to produce a score between 0 and 1 per organization. We then sum these scores across all organizations in a county, and normalize the total **per 100,000 residents**.  

  - *Example*: If the sum of these averaged scores across all organizations in a county is **1,000**, and the county population is **1,000,000**, then:  
    1,000 √∑ 1,000,000 √ó 100,000 = **100**  
    That means the county has a civic opportunity score of **100 per 100,000 residents**.

- **Civic opportunity index**: A simplified version of the score above, divided into five bins (quintiles).  
  - *1 = lowest civic opportunity*, *5 = highest*.

- **Percentile**: National percentile of the civic opportunity per capita score.  

  - *Example*: A county with a score of 125 that ranks in the top 5% of all counties would be labeled as ‚ÄúTop 5%‚Äù.

- **State Rank**: Rank of the county within its state by civic opportunity score per capita.  

- **National Rank**: Rank of the county across all U.S. counties by civic opportunity score per capita.

- **Civic Opportunity Orgs**: Count of organizations tagged as offering at least one type of civic opportunity.  

- **Total Nonprofits**: Total number of nonprofit organizations in the county.

---

**Subtypes of Civic Opportunity Organizations**

- **Membership N**: Organizations offering membership opportunities.  
- **Volunteer N**: Organizations offering volunteer opportunities.  
- **Events N**: Organizations offering public event opportunities.  
- **Take Action N**: Organizations offering civic or political action opportunities.

---

**Civic Opportunity Organizational Type Breakdown (% of all civic opportunity organizations in the county)**

  - **Religious %**, **Social & Fraternal %**, **Youth %**, **Unions %**, **Healthcare %**, **Economic %**,  
  **Education %**, **Research & Think Tank %**, **Hobby & Sports %**, **Community %**,  
  **Foundations %**, **Professional %**, **Arts & Cultural %**, **Housing %**, **Political %**

  - Each percentage represents the share of that organization type among all civic opportunity organizations in the county.  

  - *Example*: If a county has 100 civic opportunity organizations, and 12 of them are classified as ‚ÄúReligious,‚Äù the **Religious %** would be 12%.

:::

::: {.callout-note collapse=true title="üìò Codebook: Organizational Type Classification"}

| Category              | Description                                                                                                      | Examples                                                                                                                                                          |
|-----------------------|------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Arts & Cultural       | Arts organizations and cultural organizations, including those that protect community heritage                  | BANGOR SYMPHONY ORCHESTRA, BRICK STORE MUSEUM, CHESAPEAKE SHAKESPEARE COMPANY                                                                                     |
| Community             | Organizations focused on directly helping people in their community and providing community services            | WOMENS COMMUNITY CENTER, FAMILY RESOURCE CENTER OF NORTHWEST OHIO, PELLA COMMUNITY FOOD SHELF                                                                     |
| Economic              | Organizations directly promoting economic improvement in an area                                                | FALLS CITY CHAMBER OF COMMERCE, NEW ALBANY URBAN ENTERPRISE ZONE, MAIN STREET CORRIDOR DEVELOPMENT CORPORATION                                                   |
| Education             | Schools, universities, organizations that support schools, and those that provide direct education services     | JOHNS HOPKINS UNIVERSITY, THOMPSON SCHOOL PTO, LITTLE RASCALS PRESCHOOL                                                                                           |
| Foundations           | Organizations focused on granting money or scholarships to others                                               | ROBERT WOOD JOHNSON FOUNDATION, BVS FAMILY FOUNDATION                                                                                                              |
| Healthcare            | Organizations that directly deliver care or support healthcare delivery                                         | ST MARYS REGIONAL HEALTH CENTER, SOUTHERN TIER HEALTH CARE SYSTEM INC, CANCER RESOURCES FOR ELKHART COUNTY INC                                                  |
| Hobby & Sports        | Shared interest and sports organizations                                                                        | GARDEN CLUB OF KENTUCKY INC, LAGUNA YOUTH BASEBALL LEAGUE, VILLA PARK BOXING CLUB                                                                                 |
| Housing               | Organizations that provide or manage housing                                                                    | BELLE APARTMENTS HOUSING DEVELOPMENT FUND CORPORATION, CAMPUS TOWERS SENIOR LIVING INC, HABITAT FOR HUMANITY INTERNATIONAL INC                                   |
| Political             | Civic participation and political organizations involved in decision-making or advocacy                         | AMERICAN CIVIL LIBERTIES UNION, LEAGUE OF WOMEN VOTERS, ARIZONA ADVOCACY NETWORK                                                                                  |
| Professional          | Professional societies and industry groups                                                                      | NATIONAL INDEPENDENT FLAG DEALERS ASSOCIATION, BEEFMASTER BREEDERS CATTLEWOMEN, AMERICAN CANCER ASSOCIATION                                                      |
| Religious             | Religious institutions                                                                                          | CROSSROADS CHRISTIAN CHURCH, NEW SPRINGS CHURCH, MANASSAS MOSQUE                                                                                                   |
| Research & Think Tank | Think tanks and research groups                                                                                 | SOCIETY FOR THE ADVANCEMENT OF MATERIAL AND PROCESS ENGINEERING, INSTITUTE FOR CONSERVATION ADVOCACY RESEARCH AND EDUCATION, AMERICAN COUNCIL FOR CAPITAL FORMATION CENTER FOR POLICY RESEARCH |
| Social & Fraternal    | Organizations that bring people together (often based on shared identity)                                       | KNIGHTS OF COLUMBUS, ROTARY INTERNATIONAL, NATIONAL KAPPA KAPPA IOTA                                                                                               |
| Unions                | Labor unions                                                                                                    | AMERICAN FEDERATION OF STATE COUNTY & MUNICIPAL EMPLOYEES, FRESNO CITY EMPLOYEES ASSOCIATION, CIVIL SERVICE EMPLOYEES ASSOCIATION                                 |
| Youth                 | Organizations focused on working with and supporting youth                                                      | BOY SCOUTS OF AMERICA, NEBRASKA 4-H FOUNDATION, CROSSWALK TEEN CENTER                                                                                               |

:::

```{r}
# Bookmark filter checkbox
htmltools::tagList(
  tags$div(
    class = "bookmark-controls",
    style = "margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;",
    tags$label(
      style = "display: flex; align-items: center; gap: 6px; cursor: pointer;",
      tags$input(type = "checkbox", id = "bookmark-filter", onclick = "toggleBookmarkFilter()"),
      tags$span("Show only bookmarked counties")
    ),
    tags$span(id = "bookmark-count", style = "color: #666; font-size: 13px;", "0 counties bookmarked"),
    tags$button(
      id = "clear-bookmarks",
      style = "padding: 4px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: none;",
      onclick = "clearAllBookmarks()",
      "Clear All Bookmarks"
    )
  ),
  tags$div(
    style = "margin-bottom: 10px; font-style: italic; color: #555;",
    HTML("üí° <strong>Tip:</strong> Click the ‚òÜ icon to bookmark a county. Bookmarks persist in your browser.")
  )
)

# Render datatable
DT::datatable(
  df_joined,
  rownames = FALSE,
  extensions = c('FixedHeader', 'Buttons'),
  options = list(
    dom = 'Bfrtip',
    buttons = list(
      'colvis',
      list(
        extend = 'csv',
        text = 'Export CSV',
        exportOptions = list(columns = ':visible')
      )
    ),
    scrollX = TRUE,
    scrollCollapse = TRUE,
    fixedHeader = TRUE,
    pageLength = 25,
    autoWidth = TRUE,
    drawCallback = JS('function() {
      this.api().columns.adjust();
      // Initialize bookmarks after table draw
      if (typeof initializeBookmarks === "function") {
        initializeBookmarks();
      }
    }'),
    columnDefs = list(
      list(className = 'dt-center', targets = "_all"),
      list(visible = FALSE, targets = 0),  # Hide FIPS column
      list(className = 'highlight-civic', targets = 3:13),
      list(className = 'highlight-type', targets = 14:(ncol(df_joined) - 1))
    )
  ),
  filter = "top",
  class = 'stripe hover nowrap',
  callback = JS('
    // Store table reference globally
    window.civicTable = table;
  ')
)
```

```{=html}
<style>
  table.dataTable {
    width: 100% !important;
  }

  table.dataTable th,
  table.dataTable td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  table.dataTable tbody td:nth-child(2),
  table.dataTable tbody td:nth-child(3),
  table.dataTable thead th:nth-child(2),
  table.dataTable thead th:nth-child(3) {
    background-color: #f1f1f1;
    font-weight: bold;
  }

  .highlight-civic {
    background-color: #e0f7fa;
  }

  .highlight-type {
    background-color: #fff8e1;
  }

  .dataTables_wrapper {
    overflow-x: auto;
    width: 100% !important;
  }

  body, .main-container, .page-columns {
    max-width: 100% !important;
    overflow-x: visible;
  }

  /* Bookmark styles */
  .bookmark-btn {
    cursor: pointer;
    font-size: 18px;
    color: #ccc;
    background: none;
    border: none;
    padding: 0;
    transition: color 0.2s ease;
  }

  .bookmark-btn:hover {
    color: #ffc107;
  }

  .bookmark-btn.active {
    color: #ffc107;
  }

  .bookmarked-row {
    background-color: #fffde7 !important;
  }

  .bookmarked-row td {
    background-color: #fffde7 !important;
  }
</style>

<script>
  // Bookmark storage
  function getBookmarks() {
    try {
      return JSON.parse(localStorage.getItem('tableBookmarks') || '[]');
    } catch(e) {
      return [];
    }
  }

  function saveBookmarks(bookmarks) {
    localStorage.setItem('tableBookmarks', JSON.stringify(bookmarks));
    updateBookmarkUI();
  }

  function toggleBookmark(fips) {
    var bookmarks = getBookmarks();
    var idx = bookmarks.indexOf(fips);
    if (idx > -1) {
      bookmarks.splice(idx, 1);
    } else {
      bookmarks.push(fips);
    }
    saveBookmarks(bookmarks);

    // Update button state
    var btn = document.querySelector('[data-fips="' + fips + '"]');
    if (btn) {
      btn.classList.toggle('active');
      btn.textContent = btn.classList.contains('active') ? '‚òÖ' : '‚òÜ';
    }

    // Update row highlight
    updateRowHighlights();
  }

  function updateBookmarkUI() {
    var bookmarks = getBookmarks();
    var countEl = document.getElementById('bookmark-count');
    var clearBtn = document.getElementById('clear-bookmarks');

    if (countEl) {
      countEl.textContent = bookmarks.length + ' counties bookmarked';
    }
    if (clearBtn) {
      clearBtn.style.display = bookmarks.length > 0 ? 'inline-block' : 'none';
    }
  }

  function updateRowHighlights() {
    var bookmarks = getBookmarks();
    var table = document.querySelector('.dataTable');
    if (!table) return;

    var rows = table.querySelectorAll('tbody tr');
    rows.forEach(function(row) {
      var btn = row.querySelector('.bookmark-btn');
      if (btn) {
        var fips = btn.getAttribute('data-fips');
        if (bookmarks.indexOf(fips) > -1) {
          row.classList.add('bookmarked-row');
          btn.classList.add('active');
          btn.textContent = '‚òÖ';
        } else {
          row.classList.remove('bookmarked-row');
          btn.classList.remove('active');
          btn.textContent = '‚òÜ';
        }
      }
    });
  }

  function initializeBookmarks() {
    var bookmarks = getBookmarks();
    var table = document.querySelector('.dataTable');
    if (!table) return;

    // Add bookmark buttons to each row
    var rows = table.querySelectorAll('tbody tr');
    rows.forEach(function(row, index) {
      // Get FIPS from hidden first column
      var cells = row.querySelectorAll('td');
      if (cells.length > 0) {
        var fips = cells[0].textContent.trim();

        // Check if button already exists
        var existingBtn = row.querySelector('.bookmark-btn');
        if (!existingBtn) {
          // Add button to State column (index 1)
          var stateCell = cells[1];
          if (stateCell) {
            var isBookmarked = bookmarks.indexOf(fips) > -1;
            var btn = document.createElement('button');
            btn.className = 'bookmark-btn' + (isBookmarked ? ' active' : '');
            btn.setAttribute('data-fips', fips);
            btn.textContent = isBookmarked ? '‚òÖ' : '‚òÜ';
            btn.onclick = function(e) {
              e.stopPropagation();
              toggleBookmark(fips);
            };
            stateCell.insertBefore(btn, stateCell.firstChild);
            stateCell.insertBefore(document.createTextNode(' '), btn.nextSibling);

            if (isBookmarked) {
              row.classList.add('bookmarked-row');
            }
          }
        }
      }
    });

    updateBookmarkUI();
  }

  function toggleBookmarkFilter() {
    var checkbox = document.getElementById('bookmark-filter');
    var table = window.civicTable;

    if (!table) return;

    if (checkbox && checkbox.checked) {
      var bookmarks = getBookmarks();
      // Custom search to filter bookmarked rows
      $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        var fips = data[0];
        return bookmarks.indexOf(fips) > -1;
      });
    } else {
      // Remove filter
      $.fn.dataTable.ext.search.pop();
    }

    table.draw();
  }

  function clearAllBookmarks() {
    if (confirm('Clear all bookmarked counties?')) {
      saveBookmarks([]);
      updateRowHighlights();

      // If filter is active, redraw
      var checkbox = document.getElementById('bookmark-filter');
      if (checkbox && checkbox.checked) {
        checkbox.checked = false;
        toggleBookmarkFilter();
      }
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeBookmarks, 500);
    updateBookmarkUI();
  });

  // Re-initialize after DataTable redraws
  $(document).on('draw.dt', function() {
    initializeBookmarks();
  });
</script>
```