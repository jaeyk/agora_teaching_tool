---
title: "Civic Quest"
resources:
  - data/civic_quest_data.json
format:
  html:
    page-layout: full
    include-in-header:
      text: |
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
---

<div id="cq-app" class="cq-app">
  <div class="cq-top">
    <h1>Civic Quest</h1>
    <p>Type your county. Learn your place. Pick your challenge.</p>
    <div class="cq-status">
      <div id="cq-path" class="cq-path">
        <span data-stage="1" class="active">1. County Scout</span>
        <span data-stage="2">2. State Explorer</span>
        <span data-stage="3">3. Challenge</span>
        <span data-stage="4">4. Wrap-Up</span>
      </div>
      <div class="cq-score">
        <strong id="cq-xp">0 XP</strong>
        <div id="cq-badges"></div>
      </div>
    </div>
  </div>

  <div class="cq-layout">
    <section id="cq-panel" class="cq-panel"></section>
    <section class="cq-map-wrap">
      <div id="cq-map"></div>
    </section>
  </div>
</div>

<style>
#quarto-content main.content { max-width: 100%; }
.cq-app { font-family: "Trebuchet MS", "Avenir Next", "Segoe UI", sans-serif; }
.cq-top { background: linear-gradient(135deg,#14532d,#0369a1); color:#fff; border-radius:14px; padding:16px; margin-bottom:14px; }
.cq-top h1 { margin:0; font-size:2rem; }
.cq-top p { margin:.35rem 0 0; opacity:.95; }
.cq-status { margin-top:12px; display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap; }
.cq-path { display:flex; gap:8px; flex-wrap:wrap; }
.cq-path span { background:rgba(255,255,255,.2); border-radius:999px; padding:5px 10px; font-size:.82rem; }
.cq-path span.active { background:#fef08a; color:#713f12; font-weight:700; }
.cq-score { display:flex; align-items:center; gap:8px; }
#cq-badges { display:flex; flex-wrap:wrap; gap:6px; }
#cq-badges .b { background:#fff; color:#111827; border-radius:999px; padding:2px 8px; border:1px solid #ddd; font-size:.75rem; }
.cq-layout { display:grid; grid-template-columns:1.1fr 1fr; gap:14px; }
.cq-panel,.cq-map-wrap { border:1px solid #d1d5db; border-radius:14px; padding:14px; background:#fff; }
#cq-map { height:700px; border-radius:10px; }
.cq-note { color:#6b7280; margin:0 0 10px; }
.cq-search { position:relative; }
.cq-search input,.cq-select { width:100%; border:1px solid #cbd5e1; border-radius:8px; padding:10px; }
.cq-suggestions { list-style:none; margin:6px 0 0; padding:0; border:1px solid #e5e7eb; border-radius:8px; max-height:220px; overflow:auto; }
.cq-suggestions li { padding:8px 10px; border-bottom:1px solid #f3f4f6; cursor:pointer; }
.cq-suggestions li:last-child { border-bottom:0; }
.cq-suggestions li:hover { background:#f9fafb; }
.cq-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
.cq-card { border:1px solid #e5e7eb; border-radius:10px; padding:10px; }
.cq-card strong { display:block; font-size:.82rem; color:#6b7280; margin-bottom:2px; }
.cq-card span { font-size:1.2rem; font-weight:700; }
.cq-callout { margin-top:10px; background:#fff7ed; border:1px solid #fdba74; border-radius:10px; color:#7c2d12; padding:10px; }
.cq-actions { margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; }
.cq-actions button { border:0; border-radius:8px; padding:9px 12px; font-weight:700; cursor:pointer; }
.cq-primary { background:#0f766e; color:#fff; }
.cq-secondary { background:#e5e7eb; }
.cq-challenge { background:#b45309; color:#fff; }
.cq-summary { margin-top:10px; background:#ecfeff; border:1px solid #a5f3fc; border-radius:10px; padding:10px; }
@media (max-width:980px){ .cq-layout { grid-template-columns:1fr; } #cq-map { height:420px; } }
</style>

<script>
(() => {
  const state = { stage: 1, xp: 0, badges: new Set(), counties: [], states: [], county: null, stateCode: null };
  let map, marker, barChart;

  const panel = document.getElementById('cq-panel');
  const xpEl = document.getElementById('cq-xp');
  const badgesEl = document.getElementById('cq-badges');
  const pathEl = document.getElementById('cq-path');

  const fmt = (v) => Number(v || 0).toLocaleString(undefined, {maximumFractionDigits: 1});

  function updateStatus() {
    xpEl.textContent = `${state.xp} XP`;
    badgesEl.innerHTML = [...state.badges].map(b => `<span class="b">${b}</span>`).join('');
    [...pathEl.querySelectorAll('span[data-stage]')].forEach(chip => {
      chip.classList.toggle('active', Number(chip.dataset.stage) === state.stage);
    });
  }

  function addXp(x) { state.xp += x; updateStatus(); }
  function addBadge(b) { if (!state.badges.has(b)) { state.badges.add(b); updateStatus(); } }

  function ensureMap() {
    if (map) return;
    map = L.map('cq-map').setView([39.5, -98.35], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
  }

  function focusCounty(c) {
    ensureMap();
    if (marker) map.removeLayer(marker);
    marker = L.marker([c.lat, c.lon]).addTo(map).bindPopup(`${c.name}, ${c.state}`).openPopup();
    map.setView([c.lat, c.lon], 8);
  }

  function renderStage1() {
    state.stage = 1;
    updateStatus();
    panel.innerHTML = `
      <h2>Stage 1: County Scout</h2>
      <p class="cq-note">Type your county name or FIPS.</p>
      <div class="cq-search">
        <input id="cq-county-search" type="text" placeholder="Example: Autauga or 01001" autocomplete="off">
        <ul id="cq-county-suggestions" class="cq-suggestions"></ul>
      </div>
      <div id="cq-county-result"></div>
    `;

    const input = document.getElementById('cq-county-search');
    const suggestions = document.getElementById('cq-county-suggestions');
    let timer;

    input.addEventListener('input', (e) => {
      clearTimeout(timer);
      const q = e.target.value.trim().toLowerCase();
      timer = setTimeout(() => {
        if (!q) { suggestions.innerHTML = ''; return; }
        const hits = state.counties.filter(c => c.name.toLowerCase().includes(q) || c.state.toLowerCase().includes(q) || c.fips.includes(q)).slice(0, 12);
        suggestions.innerHTML = hits.map(c => `<li data-fips="${c.fips}">${c.name}, ${c.state} | ${c.urbanicity} | pop ${fmt(c.population)}</li>`).join('');
      }, 120);
    });

    suggestions.addEventListener('click', (e) => {
      const li = e.target.closest('li[data-fips]');
      if (!li) return;
      const county = state.counties.find(c => c.fips === li.dataset.fips);
      if (!county) return;
      state.county = county;
      state.stateCode = county.state;
      addXp(20);
      addBadge('Home County Discovered');
      renderCountyResult(county);
      if (county.lat && county.lon) focusCounty(county);
      suggestions.innerHTML = '';
    });
  }

  function renderCountyResult(c) {
    const box = document.getElementById('cq-county-result');
    box.innerHTML = `
      <div class="cq-summary"><strong>Unlocked clue:</strong> ${c.name}, ${c.state} is <strong>${c.urbanicity}</strong>. Civic score <strong>${fmt(c.score)}</strong>, state rank <strong>#${c.state_rank}</strong>.</div>
      <div class="cq-grid">
        <div class="cq-card"><strong>Score</strong><span>${fmt(c.score)}</span></div>
        <div class="cq-card"><strong>National Percentile</strong><span>${fmt(c.national_percentile)}%</span></div>
        <div class="cq-card"><strong>Population</strong><span>${fmt(c.population)}</span></div>
        <div class="cq-card"><strong>Civic Orgs</strong><span>${fmt(c.metrics.civic_orgs)}</span></div>
      </div>
      <div class="cq-callout">Why this matters: counties in the same RUCC group can still have very different civic opportunity levels.</div>
      <canvas id="cq-county-chart"></canvas>
      <div class="cq-actions">
        <button id="cq-go-state" class="cq-primary">Learn About My State</button>
        <button id="cq-go-challenge" class="cq-challenge">Jump to Challenge</button>
      </div>
    `;

    if (barChart) barChart.destroy();
    barChart = new Chart(document.getElementById('cq-county-chart'), {
      type: 'bar',
      data: {
        labels: ['Membership', 'Volunteer', 'Events', 'Take Action'],
        datasets: [{
          data: [c.metrics.membership, c.metrics.volunteer, c.metrics.events, c.metrics.take_action],
          backgroundColor: ['#0284c7','#16a34a','#d97706','#dc2626']
        }]
      },
      options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    document.getElementById('cq-go-state').addEventListener('click', () => { addXp(10); renderStage2(); });
    document.getElementById('cq-go-challenge').addEventListener('click', () => { addXp(10); renderStage3(); });
  }

  function renderStage2() {
    if (!state.stateCode) return;
    state.stage = 2;
    updateStatus();
    const s = state.states.find(x => x.state === state.stateCode);
    if (!s) return;

    panel.innerHTML = `
      <h2>Stage 2: State Explorer</h2>
      <p class="cq-note">Now compare county types within your state.</p>
      <div class="cq-grid">
        <div class="cq-card"><strong>State</strong><span>${s.state}</span></div>
        <div class="cq-card"><strong>Avg Score</strong><span>${fmt(s.avg_score)}</span></div>
        <div class="cq-card"><strong>County Count</strong><span>${fmt(s.county_count)}</span></div>
        <div class="cq-card"><strong>Top County</strong><span>${s.top_county}</span></div>
      </div>
      <div class="cq-summary">Urbanicity source: ${window.__cqMeta.urbanicity_source}</div>
      <canvas id="cq-state-chart"></canvas>
      <div class="cq-actions">
        <button id="cq-to-challenge" class="cq-challenge">Start Challenge</button>
        <button id="cq-back-county" class="cq-secondary">Back</button>
      </div>
    `;

    if (barChart) barChart.destroy();
    barChart = new Chart(document.getElementById('cq-state-chart'), {
      type: 'bar',
      data: {
        labels: ['Urban', 'Suburban', 'Rural'],
        datasets: [{ data: [s.urban_avg, s.suburban_avg, s.rural_avg], backgroundColor: ['#2563eb','#b45309','#15803d'] }]
      },
      options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    addXp(20);
    addBadge('State Decoder');
    document.getElementById('cq-to-challenge').addEventListener('click', renderStage3);
    document.getElementById('cq-back-county').addEventListener('click', renderStage1);
  }

  function renderStage3() {
    state.stage = 3;
    updateStatus();
    panel.innerHTML = `
      <h2>Stage 3: Challenge</h2>
      <p class="cq-note">Choose your comparison mode.</p>
      <div class="cq-actions">
        <button id="cq-mode-state" class="cq-challenge">State vs State</button>
        <button id="cq-mode-county" class="cq-challenge">County vs County</button>
        <button id="cq-mode-peers" class="cq-challenge">County vs Similar Counties</button>
      </div>
      <div id="cq-challenge-area"></div>
    `;
    document.getElementById('cq-mode-state').addEventListener('click', renderStateVsState);
    document.getElementById('cq-mode-county').addEventListener('click', renderCountyVsCounty);
    document.getElementById('cq-mode-peers').addEventListener('click', renderPeers);
  }

  function renderStateVsState() {
    const area = document.getElementById('cq-challenge-area');
    const opts = state.states.map(s => `<option value="${s.state}">${s.state}</option>`).join('');
    area.innerHTML = `
      <div class="cq-grid" style="margin-top:10px;">
        <div><strong>Your state</strong><select id="cq-state-a" class="cq-select">${opts}</select></div>
        <div><strong>Other state</strong><select id="cq-state-b" class="cq-select"><option value="">Select</option>${opts}</select></div>
      </div>
      <div class="cq-actions"><button id="cq-run-state" class="cq-primary">Run</button></div>
      <div id="cq-state-result"></div>
    `;
    document.getElementById('cq-state-a').value = state.stateCode || '';

    document.getElementById('cq-run-state').addEventListener('click', () => {
      const a = document.getElementById('cq-state-a').value;
      const b = document.getElementById('cq-state-b').value;
      if (!a || !b || a === b) return;
      const sa = state.states.find(s => s.state === a);
      const sb = state.states.find(s => s.state === b);
      const gaps = {
        urban: (sa.urban_avg - sb.urban_avg).toFixed(2),
        suburban: (sa.suburban_avg - sb.suburban_avg).toFixed(2),
        rural: (sa.rural_avg - sb.rural_avg).toFixed(2),
        avg: (sa.avg_score - sb.avg_score).toFixed(2),
      };
      document.getElementById('cq-state-result').innerHTML = `
        <div class="cq-callout">Biggest clue: urban gap ${gaps.urban}, rural gap ${gaps.rural} (${a} minus ${b}).</div>
        <canvas id="cq-gap-chart"></canvas>
        <div class="cq-actions"><button id="cq-finish" class="cq-primary">Finish Quest</button></div>
      `;
      if (barChart) barChart.destroy();
      barChart = new Chart(document.getElementById('cq-gap-chart'), {
        type:'bar',
        data:{ labels:['Urban gap','Suburban gap','Rural gap','Overall gap'], datasets:[{ data:[gaps.urban,gaps.suburban,gaps.rural,gaps.avg], backgroundColor:['#1d4ed8','#a16207','#15803d','#7c3aed'] }] },
        options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
      addXp(30);
      addBadge('Cross-State Challenger');
      document.getElementById('cq-finish').addEventListener('click', renderStage4);
    });
  }

  function renderCountyVsCounty() {
    const area = document.getElementById('cq-challenge-area');
    if (!state.county) { area.innerHTML = '<div class="cq-callout">Pick a county first in Stage 1.</div>'; return; }
    area.innerHTML = `
      <div class="cq-search" style="margin-top:10px;">
        <input id="cq-other-county" type="text" placeholder="Type other county name or FIPS" autocomplete="off">
        <ul id="cq-other-suggestions" class="cq-suggestions"></ul>
      </div>
      <div id="cq-county-result2"></div>
    `;
    const input = document.getElementById('cq-other-county');
    const sug = document.getElementById('cq-other-suggestions');
    let timer;
    input.addEventListener('input', (e) => {
      clearTimeout(timer);
      const q = e.target.value.trim().toLowerCase();
      timer = setTimeout(() => {
        if (!q) { sug.innerHTML=''; return; }
        const hits = state.counties.filter(c => c.name.toLowerCase().includes(q) || c.fips.includes(q)).slice(0, 12);
        sug.innerHTML = hits.map(c => `<li data-fips="${c.fips}">${c.name}, ${c.state} | ${c.urbanicity}</li>`).join('');
      }, 120);
    });
    sug.addEventListener('click', (e) => {
      const li = e.target.closest('li[data-fips]');
      if (!li) return;
      const other = state.counties.find(c => c.fips === li.dataset.fips);
      if (!other) return;
      const a = state.county;
      const delta = (a.score - other.score).toFixed(2);
      document.getElementById('cq-county-result2').innerHTML = `
        <div class="cq-grid" style="margin-top:10px;">
          <div class="cq-card"><strong>${a.name}, ${a.state}</strong><span>${fmt(a.score)}</span></div>
          <div class="cq-card"><strong>${other.name}, ${other.state}</strong><span>${fmt(other.score)}</span></div>
        </div>
        <div class="cq-callout">Score difference clue: ${delta} (${a.name} minus ${other.name}).</div>
        <div class="cq-actions"><button id="cq-finish" class="cq-primary">Finish Quest</button></div>
      `;
      addXp(30);
      addBadge('County Duelist');
      document.getElementById('cq-finish').addEventListener('click', renderStage4);
    });
  }

  function renderPeers() {
    const area = document.getElementById('cq-challenge-area');
    if (!state.county) { area.innerHTML = '<div class="cq-callout">Pick a county first in Stage 1.</div>'; return; }
    const peers = state.county.peers || [];
    if (!peers.length) { area.innerHTML = '<div class="cq-callout">No same-group peers found.</div>'; return; }
    area.innerHTML = `
      <div class="cq-summary">Peers in your state with the same group (${state.county.urbanicity}):</div>
      <ol>${peers.map(p => `<li>${p.name}, ${p.state} - ${fmt(p.score)}</li>`).join('')}</ol>
      <div class="cq-callout">Interpretation clue: compare whether your county over- or under-performs against same-group peers.</div>
      <div class="cq-actions"><button id="cq-finish" class="cq-primary">Finish Quest</button></div>
    `;
    addXp(30);
    addBadge('Urban-Rural Analyst');
    document.getElementById('cq-finish').addEventListener('click', renderStage4);
  }

  function renderStage4() {
    state.stage = 4;
    updateStatus();
    const c = state.county;
    const line = c ? `${c.name}, ${c.state} is ${c.urbanicity} with score ${fmt(c.score)}.` : 'No county selected.';
    panel.innerHTML = `
      <h2>Stage 4: Wrap-Up</h2>
      <div class="cq-summary">
        <p><strong>County insight:</strong> ${line}</p>
        <p><strong>State explored:</strong> ${state.stateCode || 'N/A'}</p>
        <p><strong>XP:</strong> ${state.xp}</p>
        <p><strong>Badges:</strong> ${[...state.badges].join(', ') || 'None'}</p>
      </div>
      <div class="cq-actions"><button id="cq-restart" class="cq-primary">Start Over</button></div>
    `;
    addBadge('Civic Strategist');
    document.getElementById('cq-restart').addEventListener('click', () => {
      state.stage = 1; state.xp = 0; state.badges = new Set(); state.county = null; state.stateCode = null;
      if (marker && map) { map.removeLayer(marker); marker = null; }
      updateStatus(); renderStage1();
    });
  }

  async function init() {
    ensureMap();
    const payload = await fetch('data/civic_quest_data.json').then(r => r.json());
    state.counties = payload.counties || [];
    state.states = payload.states || [];
    window.__cqMeta = payload.metadata || {};
    updateStatus();
    renderStage1();
  }

  init();
})();
</script>
